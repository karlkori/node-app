box: node

build:
  steps:
    - script:
        name: setup node env
        code: |
          export NODE_ENV=development
    - npm-install
    - script:
        code: cp ./* $WERCKER_OUTPUT_DIR
    - script:
        code: npm i -g pm2

test:
  steps:
    - script:
        name: run tests
        code: |
          npm test

# build:
#   steps:	
#     - script:
#         code: docker build -t node-app .
#     - script:
#         code: docker tag node-app:latest 433478262461.dkr.ecr.us-east-1.amazonaws.com/node-app:latest
# release-build:
#   steps:
#     - script:
#         name: npm rebuild
#         code: |
#           npm rebuild

#     - script:
#         name: build release code
#         code: |
#           npm run build
#           mv ./build/* $WERCKER_OUTPUT_DIR
#           mv template.sh $WERCKER_OUTPUT_DIR

push-to-ecr:
  steps:
    - internal/docker-push:
        aws-access-key: $AWS_ACCESS_KEY_ID
        aws-secret-key: $AWS_SECRET_ACCESS_KEY
        aws-region: $AWS_REGION
        aws-registry-id: $AWS_REGISTRY_ID
        repository: node-app
        tag: $WERCKER_GIT_BRANCH
        cmd: "pm2-docker processes.json"
        ports: 9999

deploy-to-ecs:
  steps:
    - 1science/aws-ecs:
        key: $AWS_ACCESS_KEY_ID
        secret: $AWS_SECRET_ACCESS_KEY
        cluster-name: $AWS_ECS_CLUSTER
        service-name: node-app-service
        minimum-running-tasks: 1
        task-definition-name: node-app-task-definition-$WERCKER_GIT_BRANCH
        task-definition-file: $WERCKER_SOURCE_DIR/node-app-task-definition-$WERCKER_GIT_BRANCH.json

